<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mr Nathan's GCSE Maths Question Bank</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #f5f7fb; }
    .container { max-width: 900px; margin: 40px auto; background: #ffffff; padding: 24px 28px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h1 { margin-top: 0; font-size: 1.6rem; color: #134b9b; }
    .subtitle { color: #555; margin-bottom: 16px; font-size: 0.95rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; align-items: center; }
    select, button { padding: 8px 12px; font-size: 0.95rem; border-radius: 4px; border: 1px solid #c5cbe0; background: #ffffff; cursor: pointer; }
    button { background: #134b9b; color: #fff; border: none; }
    button:hover { background: #0f3f84; }
    .meta { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
    .question-text { font-size: 1.05rem; margin: 12px 0 16px; white-space: pre-wrap; }
    .options { list-style: none; padding: 0; margin: 0 0 16px; }
    .options li { margin-bottom: 6px; }
    .option-label { display: inline-block; width: 20px; font-weight: bold; }
    .solution { border-top: 1px solid #dde3f5; margin-top: 12px; padding-top: 12px; display: none; font-size: 0.95rem; }
    .solution pre { margin: 0; white-space: pre-wrap; font-family: inherit; }
    .difficulty { font-weight: bold; }
    .footer-note { margin-top: 20px; font-size: 0.8rem; color: #999; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #e7eefe; color: #134b9b; font-size: 0.75rem; margin-right: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mr Nathan's GCSE Maths Question Bank</h1>
    <div class="subtitle">Intermediate Tier • Random, regeneratable MCQs with full worked solutions.</div>

    <div class="controls">
      <label for="topicSelect">Topic:</label>
      <select id="topicSelect">
        <option value="all">(All topics)</option>
        <option value="Number">Number</option>
        <option value="Algebra">Algebra</option>
        <option value="Geometry & Measure">Geometry & Measure</option>
        <option value="Statistics & Probability">Statistics & Probability</option>
      </select>

      <button id="newQuestionBtn">New Question</button>
      <button id="showSolutionBtn">Show Solution</button>
    </div>

    <div class="meta">
      <span id="topicTag" class="pill"></span>
      <span id="skillTag" class="pill"></span>
      <span class="difficulty">Difficulty: <span id="difficultyText"></span></span>
    </div>

    <div class="question-text" id="questionText">Click “New Question” to begin.</div>
    <ul class="options" id="optionsList"></ul>

    <div class="solution" id="solutionBlock">
      <strong>Worked solution</strong>
      <pre id="solutionText"></pre>
    </div>

    <div class="footer-note">This is a growing question bank. Next goal: make Number fully exam-complete for WJEC GCSE Intermediate Tier.</div>
  </div>

  <script>
    // ---------- Utilities ----------
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function shuffleArray(arr) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function buildMCQOptions(correctText, distractorTexts) {
      const all = [String(correctText), ...distractorTexts.map(String)];
      const shuffled = shuffleArray(all);
      return { options: shuffled, correctIndex: shuffled.findIndex(v => v === String(correctText)) };
    }

    function gcd(a, b) {
      a = Math.abs(a); b = Math.abs(b);
      while (b !== 0) { const t = b; b = a % b; a = t; }
      return a;
    }

    function simplifyFraction(n, d) {
      const g = gcd(n, d);
      return { n: n / g, d: d / g };
    }

    // ---------- GCSE formatting helpers ----------
    function sup(n) { return `<sup>${n}</sup>`; }

    function safeRound(x, dp=10) {
      // Prevent 27.599999999999998 style artefacts
      const m = Math.pow(10, dp);
      return Math.round((x + Number.EPSILON) * m) / m;
    }

    function decimalToFraction(x) {
      // Convert a terminating decimal to a simplified fraction.
      // Works well for our generated numbers (mostly terminating).
      const EPS = 1e-10;
      let v = safeRound(x, 10);

      // If effectively an integer:
      if (Math.abs(v - Math.round(v)) < EPS) return { n: Math.round(v), d: 1 };

      let d = 1;
      while (d <= 1000 && Math.abs(v * d - Math.round(v * d)) > EPS) d *= 10;

      const n = Math.round(v * d);
      const simp = simplifyFraction(n, d);
      return simp;
    }

    function toMixedNumberString(x) {
      const frac = decimalToFraction(x);
      const n = frac.n, d = frac.d;

      if (d === 1) return String(n);

      const sign = n < 0 ? -1 : 1;
      const absN = Math.abs(n);

      const whole = Math.floor(absN / d);
      const rem = absN % d;

      if (whole === 0) return `${sign < 0 ? "-" : ""}${rem}/${d}`;
      if (rem === 0) return String(sign * whole);

      return `${sign < 0 ? "-" : ""}${whole} ${rem}/${d}`;
    }

    function stripTrailingZeros(numStr) {
      if (!numStr.includes(".")) return numStr;
      return numStr.replace(/\.0+$/, "").replace(/(\.\d*[1-9])0+$/, "$1");
    }

    function normaliseSci(coeff, power) {
      let c = coeff;
      let p = power;
      const EPS = 1e-12;

      while (c >= 10 - EPS) { c /= 10; p += 1; }
      while (c < 1 - EPS) { c *= 10; p -= 1; }

      // keep to 1dp, then re-check bounds in case rounding pushes to 10
      c = Math.round(c * 10) / 10;
      if (c >= 10) { c /= 10; p += 1; }

      return { coeff: c, power: p };
    }

    function sciHTML(coeff, power) {
      const norm = normaliseSci(coeff, power);
      // Your preference: show one decimal place in standard form (e.g. 2.0 × 10^0)
      const cStr = (Math.round(norm.coeff * 10) / 10).toFixed(1);
      return `${cStr} × 10${sup(norm.power)}`;
    }

    function coeffPowerToPlainDecimal(coeffStr, power) {
      // Build a decimal string WITHOUT e-notation
      const dotIndex = coeffStr.indexOf(".");
      const digitsBeforeDot = (dotIndex === -1) ? coeffStr.length : dotIndex;
      const digitsOnly = coeffStr.replace(".", "");
      const totalDigits = digitsOnly.length;

      const newDecimalPos = digitsBeforeDot + power;

      if (newDecimalPos >= totalDigits) {
        const zeros = "0".repeat(newDecimalPos - totalDigits);
        return digitsOnly + zeros;
      }
      if (newDecimalPos <= 0) {
        const zeros = "0".repeat(-newDecimalPos);
        return "0." + zeros + digitsOnly;
      }

      const left = digitsOnly.slice(0, newDecimalPos);
      const right = digitsOnly.slice(newDecimalPos);
      const rightTrimmed = right.replace(/0+$/, "");
      return rightTrimmed.length ? (left + "." + rightTrimmed) : left;
    }

    // ---------- Templates ----------
    function makePowersRootsQuestion() {
      const mode = Math.random() < 0.5 ? "power" : "root";

      if (mode === "power") {
        const bases = [2,3,4,5,6,7,8,9];
        const b = bases[randInt(0, bases.length - 1)];
        const n = randInt(2, 4);
        const correct = Math.pow(b, n);

        const { options, correctIndex } = buildMCQOptions(String(correct), [
          String(b * n),
          String(Math.pow(b, n - 1)),
          String(Math.pow(n, b))
        ]);

        return {
          topic: "Number",
          skill: "Powers",
          difficulty: "Foundation / Core",
          questionHTML: `Evaluate: ${b}${sup(n)}`,
          optionsHTML: options,
          correctIndex,
          solutionHTML: `${b}${sup(n)} = ${correct}.`
        };
      } else {
        const squares = [16,25,36,49,64,81,100,121,144,169,196,225];
        const s = squares[randInt(0, squares.length - 1)];
        const correct = Math.round(Math.sqrt(s));

        const { options, correctIndex } = buildMCQOptions(String(correct), [
          String(s / 2),
          String(correct * 2),
          String(correct - 1)
        ]);

        return {
          topic: "Number",
          skill: "Square roots",
          difficulty: "Foundation / Core",
          questionHTML: `Evaluate: √${s}`,
          optionsHTML: options,
          correctIndex,
          solutionHTML: `√${s} = ${correct} because ${correct} × ${correct} = ${s}.`
        };
      }
    }

    function makePercentOfAmountQuestion() {
      const base = randInt(6, 60) * 5; // multiples of 5
      const percentChoices = [5, 10, 12, 15, 20, 25, 30, 35, 40, 45];
      const p = percentChoices[randInt(0, percentChoices.length - 1)];

      const raw = (p / 100) * base;
      const correctVal = safeRound(raw, 10);

      const correctText = toMixedNumberString(correctVal);

      const wrong1 = toMixedNumberString(safeRound(base * (100 / p), 10));
      const wrong2 = toMixedNumberString(safeRound(base * (p / 10), 10));
      const wrong3 = toMixedNumberString(safeRound(base + correctVal, 10));

      const { options, correctIndex } = buildMCQOptions(correctText, [wrong1, wrong2, wrong3]);

      const solution =
        `${p}% of ${base} = ${p}/100 × ${base}\n` +
        `= ${toMixedNumberString(safeRound((p * base) / 100, 10))}`;

      return {
        topic: "Number",
        skill: "Percentage of an amount",
        difficulty: "Foundation / Core",
        questionHTML: `Find ${p}% of ${base}.`,
        optionsHTML: options,
        correctIndex,
        solutionHTML: solution
      };
    }

    function makeStandardFormQuestion() {
      // Start from correct standard form seed (1dp)
      const coeff = (randInt(12, 98) / 10); // 1.2 .. 9.8
      const power = randInt(-4, 5);

      const coeffStr = coeff.toFixed(1); // keep 1dp (e.g. 2.0)
      const ordinaryText = coeffPowerToPlainDecimal(coeffStr, power);

      const correctHTML = sciHTML(coeff, power);

      // Distractors (GCSE style)
      const d1 = sciHTML(coeff, -power);             // sign error
      const d2 = sciHTML(coeff * 10, power);         // decimal shift error
      const d3 = sciHTML(coeff / 10, power);         // decimal shift error opposite way

      const distractors = Array.from(new Set([d1, d2, d3].filter(v => v !== correctHTML)));
      while (distractors.length < 3) distractors.push(sciHTML(randInt(12,98)/10, randInt(-6,6)));

      const { options, correctIndex } = buildMCQOptions(correctHTML, distractors.slice(0,3));

      const solution =
        `Standard form is a × 10ⁿ where 1 ≤ a < 10.\n` +
        `${ordinaryText} = ${correctHTML}`;

      return {
        topic: "Number",
        skill: "Standard form (convert)",
        difficulty: "Core / Intermediate",
        questionHTML: `Write ${ordinaryText} in standard form.`,
        optionsHTML: options,
        correctIndex,
        solutionHTML: solution
      };
    }

    // Keep a couple of existing examples so your site still feels “full”
    function makeBIDMASQuestion() {
      const a = randInt(5, 30);
      const b = randInt(2, 9);
      const c = randInt(10, 30);
      const d = randInt(1, 9);
      const e = [2,3,4,5][randInt(0, 3)];
      const inner = c - d;
      const value = a + (b * inner) / e;

      const correctText = Number.isInteger(value) ? String(value) : stripTrailingZeros(safeRound(value, 2).toFixed(2));
      const wrong1 = stripTrailingZeros(safeRound(((a + b) * inner) / e, 2).toFixed(2));
      const wrong2 = stripTrailingZeros(safeRound((a + b * inner) / e, 2).toFixed(2));
      const wrong3 = stripTrailingZeros(safeRound(a + b * inner / e + 1, 2).toFixed(2));

      const { options, correctIndex } = buildMCQOptions(correctText, [wrong1, wrong2, wrong3]);

      const solution =
        `Work out brackets first: (${c} - ${d}) = ${inner}\n` +
        `Then × and ÷: ${b} × ${inner} ÷ ${e}\n` +
        `Then add ${a}\n` +
        `Answer = ${correctText}`;

      return {
        topic: "Number",
        skill: "BIDMAS / order of operations",
        difficulty: "Core / Intermediate",
        questionHTML: `Work out: ${a} + ${b} × (${c} - ${d}) ÷ ${e}`,
        optionsHTML: options,
        correctIndex,
        solutionHTML: solution
      };
    }

    function makeFractionOfAmountQuestion() {
      const fracs = [{n:1,d:2},{n:1,d:3},{n:2,d:3},{n:1,d:4},{n:3,d:4},{n:2,d:5},{n:3,d:5}];
      const f = fracs[randInt(0, fracs.length - 1)];
      const k = randInt(6, 40);
      const amount = f.d * k;
      const correct = (f.n / f.d) * amount;

      const correctText = toMixedNumberString(correct);
      const wrong1 = toMixedNumberString(amount / f.d);
      const wrong2 = toMixedNumberString(amount * f.n);
      const wrong3 = toMixedNumberString(amount / f.n);

      const { options, correctIndex } = buildMCQOptions(correctText, [wrong1, wrong2, wrong3]);

      const solution =
        `${f.n}/${f.d} of ${amount} = (${f.n} × ${amount}) ÷ ${f.d}\n` +
        `= ${f.n * amount} ÷ ${f.d} = ${correctText}`;

      return {
        topic: "Number",
        skill: "Fraction of an amount",
        difficulty: "Foundation / Core",
        questionHTML: `Find ${f.n}/${f.d} of ${amount}.`,
        optionsHTML: options,
        correctIndex,
        solutionHTML: solution
      };
    }

    // ---------- Question bank ----------
    const questionBank = [
      makePowersRootsQuestion,
      makePercentOfAmountQuestion,
      makeStandardFormQuestion,
      makeFractionOfAmountQuestion,
      makeBIDMASQuestion
    ];

    // ---------- App wiring ----------
    let currentQuestion = null;

    const topicSelect = document.getElementById("topicSelect");
    const newQuestionBtn = document.getElementById("newQuestionBtn");
    const showSolutionBtn = document.getElementById("showSolutionBtn");
    const questionTextEl = document.getElementById("questionText");
    const optionsListEl = document.getElementById("optionsList");
    const solutionBlockEl = document.getElementById("solutionBlock");
    const solutionTextEl = document.getElementById("solutionText");
    const topicTagEl = document.getElementById("topicTag");
    const skillTagEl = document.getElementById("skillTag");
    const difficultyTextEl = document.getElementById("difficultyText");

    function generateQuestion() {
      const chosenTopic = topicSelect.value;
      let availableFactories = questionBank;

      if (chosenTopic !== "all") {
        availableFactories = questionBank.filter(factory => factory().topic === chosenTopic);
      }

      if (availableFactories.length === 0) {
        questionTextEl.textContent = "No questions available yet for this topic.";
        optionsListEl.innerHTML = "";
        solutionBlockEl.style.display = "none";
        topicTagEl.textContent = "";
        skillTagEl.textContent = "";
        difficultyTextEl.textContent = "";
        return;
      }

      const factory = availableFactories[randInt(0, availableFactories.length - 1)];
      currentQuestion = factory();

      topicTagEl.textContent = currentQuestion.topic;
      skillTagEl.textContent = currentQuestion.skill;
      difficultyTextEl.textContent = currentQuestion.difficulty;

      // Allow superscripts in questions
      questionTextEl.innerHTML = currentQuestion.questionHTML;

      optionsListEl.innerHTML = "";
      const labels = ["A", "B", "C", "D"];
      currentQuestion.optionsHTML.forEach((opt, index) => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="option-label">${labels[index]}.</span> ${opt}`;
        optionsListEl.appendChild(li);
      });

      // Allow superscripts in solutions too
      solutionTextEl.innerHTML = currentQuestion.solutionHTML;
      solutionBlockEl.style.display = "none";
    }

    newQuestionBtn.addEventListener("click", generateQuestion);
    showSolutionBtn.addEventListener("click", () => { if (currentQuestion) solutionBlockEl.style.display = "block"; });
  </script>
</body>
</html>
